# SharePoint Activity Logging

## Overview

The application automatically logs user login activities to a SharePoint list using Microsoft Graph API.

## Configuration

### Environment Variables

Add these to your `.env` file:

```env
SP_SITE_URL=https://peakcampus.sharepoint.com/sites/BaseCampApps
SP_LOG_LIST_ID=ffa79c02-df7b-4f67-afa1-fe207c50baad
```

### Required Permissions

The OAuth application must have the following Microsoft Graph API permissions:
- `Sites.ReadWrite.All` - Required to write to SharePoint lists

## SharePoint List Structure

The activity log list should have the following columns:

| Column Name | Type | Description |
|-------------|------|-------------|
| Title | Single line of text | Activity summary (auto-generated) |
| UserEmail | Single line of text | User's email address |
| UserName | Single line of text | User's display name |
| LoginTimestamp | Date and Time | When the activity occurred (UTC) |
| UserRole | Single line of text | User's role in the application |
| ActivityType | Choice | Type of activity (Login, Logout, View, Edit) |
| Application | Single line of text | Application name |
| Modified | Date and Time | Auto-generated by SharePoint |
| Created | Date and Time | Auto-generated by SharePoint |
| Created By | Person or Group | Auto-generated by SharePoint |
| Modified By | Person or Group | Auto-generated by SharePoint |

### ActivityType Choice Values

Configure the ActivityType field with these choices:
- Login
- Logout
- View
- Edit
- Create
- Delete
- Error

## How It Works

### Login Activity Logging

When a user successfully logs in:

1. User authenticates via Microsoft OAuth
2. Application retrieves user information from Microsoft Graph
3. Access token is obtained with `Sites.ReadWrite.All` permission
4. SharePoint service is initialized with the access token
5. Login activity is logged to the SharePoint list with:
   - User's email and name
   - Current timestamp (UTC)
   - Activity type: "Login"
   - Application: "Horror Movie Calendar"
   - User role: "User" (default)

### Implementation Details

The logging is implemented in three components:

1. **SharePoint Service** (`app/services/sharepoint_service.py`)
   - `SharePointService` class handles all SharePoint operations
   - `log_login_activity()` helper function for easy login logging
   - Uses Microsoft Graph API v1.0

2. **Auth Routes** (`app/routes/auth_routes.py`)
   - Calls `log_login_activity()` after successful authentication
   - Handles errors gracefully (logs warning if SharePoint logging fails)
   - User can still log in even if SharePoint logging fails

3. **Configuration** (`app/auth/config.py`)
   - Loads `SP_SITE_URL` and `SP_LOG_LIST_ID` from environment variables
   - Validates configuration on startup

## Usage Examples

### Manual Logging

You can manually log activities using the SharePoint service:

```python
from app.services.sharepoint_service import SharePointService
from flask import session

# Initialize service
sp_service = SharePointService(
    site_url="https://peakcampus.sharepoint.com/sites/BaseCampApps",
    access_token=session.get('access_token')
)

# Log an activity
sp_service.log_user_activity(
    list_id="ffa79c02-df7b-4f67-afa1-fe207c50baad",
    user_email="user@example.com",
    user_name="John Doe",
    activity_type="View",
    application="Horror Movie Calendar",
    user_role="User"
)
```

### Using the Helper Function

For login activities, use the helper function:

```python
from app.services.sharepoint_service import log_login_activity
from flask import session

success = log_login_activity(
    access_token=session.get('access_token'),
    site_url="https://peakcampus.sharepoint.com/sites/BaseCampApps",
    list_id="ffa79c02-df7b-4f67-afa1-fe207c50baad",
    user_email="user@example.com",
    user_name="John Doe",
    user_role="User"
)
```

## Error Handling

The application handles SharePoint logging errors gracefully:

- If SharePoint logging fails, the user can still log in successfully
- Errors are logged to the application log for troubleshooting
- If `SP_SITE_URL` or `SP_LOG_LIST_ID` is not configured, logging is skipped with a warning

## Troubleshooting

### "Failed to get site ID"

**Cause**: Invalid SharePoint site URL or insufficient permissions

**Solutions**:
- Verify `SP_SITE_URL` is correct in `.env`
- Ensure OAuth app has `Sites.ReadWrite.All` permission
- Check that the user has access to the SharePoint site

### "Failed to add list item"

**Cause**: Invalid list ID or field configuration

**Solutions**:
- Verify `SP_LOG_LIST_ID` is correct in `.env`
- Ensure all required fields exist in the SharePoint list
- Check field types match the data being sent
- Verify user has write permissions to the list

### "Token refresh failed"

**Cause**: Access token expired or invalid

**Solutions**:
- Ensure `ensure_fresh_access_token()` is called before SharePoint operations
- Check OAuth token refresh is working correctly
- Verify `Sites.ReadWrite.All` scope is requested during login

## Testing

To test SharePoint logging:

1. Ensure environment variables are set correctly
2. Log in to the application
3. Check the application logs for:
   ```
   Login activity logged for user@example.com
   ```
4. Verify in SharePoint that a new item was created in the log list
5. Check the item has all required fields populated

## Security Considerations

- Access tokens are never exposed to the client
- SharePoint operations use the authenticated user's token
- All timestamps are stored in UTC
- Failed logging attempts are logged but don't prevent user login
- SharePoint list permissions control who can view/edit logs

## Future Enhancements

Potential improvements:
- Log logout activities
- Log page views and actions
- Add error logging for application errors
- Implement batch logging for better performance
- Add audit report generation
- Include IP address and user agent tracking
